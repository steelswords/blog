<!doctype html><html data-theme=dark lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://tristanandrus.com name=base><title>Tristan Andrus ‚Ä¢ Linux Kernel Development, part 2: Character Devices</title><link href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 105 55"><text y=".7em" font-size="82">üíª</text></svg>' rel=icon><link title="Tristan Andrus - Atom Feed" href=https://tristanandrus.com/atom.xml rel=alternate type=application/atom+xml><link href="https://tristanandrus.com/spoilersection.css?h=a8f027ae57acf043de52" rel=stylesheet><link href="https://tristanandrus.com/attributedblockquote.css?h=1b96ca8639a3c4a94489" rel=stylesheet><link href="https://tristanandrus.com/custom_subset.css?h=0b9535a28bc3d5bf2321" rel=stylesheet><link href="https://tristanandrus.com/main.css?h=4a3dff148c520f191505" rel=stylesheet><meta content=dark name=color-scheme><meta content="Let's write a kernel module to give us /dev/fibonacci, which gives us Fibonacci numbers when read" name=description><meta content="Let's write a kernel module to give us /dev/fibonacci, which gives us Fibonacci numbers when read" property=og:description><meta content="index, nofollow" name=robots><meta content="Linux Kernel Development, part 2: Character Devices" property=og:title><meta content=article property=og:type><meta content=en_GB property=og:locale><meta content=https://tristanandrus.com/blog/linux-kernel-development-part-2/ property=og:url><meta content="Tristan Andrus" property=og:site_name><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'" http-equiv=Content-Security-Policy><script defer src=https://tristanandrus.com/js/toggle_spoiler.js></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://tristanandrus.com>Tristan Andrus</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://tristanandrus.com/experience/> experience </a><li><a class="nav-links no-hover-padding" href=https://tristanandrus.com/blog/> blog </a><li><a class="nav-links no-hover-padding" href=https://tristanandrus.com/tags/> tags </a><li><a class="nav-links no-hover-padding" href=https://tristanandrus.com/archive/> archive </a></li><div class=nav-navs id=menu-icons-group></div></ul></div></nav></header><div class=content><main><article><h1 class=article-title>Linux Kernel Development, part 2: Character Devices</h1><ul class=meta><li>21st Jan 2023<li title="964 words"><span aria-hidden=true class=separator>‚Ä¢</span>5 min read<li class=tag><span aria-hidden=true class=separator>‚Ä¢</span>Tags:¬†<li class=tag><a href=https://tristanandrus.com/tags/kernel/>kernel</a>,¬†<li class=tag><a href=https://tristanandrus.com/tags/linux/>linux</a>,¬†<li class=tag><a href=https://tristanandrus.com/tags/showcase/>showcase</a></ul><section class=body><p>Now that we‚Äôve done <a href=https://tristanandrus.com/blog/linux-kernel-development-part-1/>a ‚ÄúHello, World‚Äù kernel module</a>, let‚Äôs dive into something a little less trivial: a character device driver. This will allow us to create a file in <code>/dev</code> that we can read and write from. Our goal here is to make a <code>/dev/fibonacci0</code> device that gives us the next Fibonacci number every time we read from it.<p>This article will give a brief overview of what‚Äôs going on since a comprehensive treatment of the concepts involved is more than I want to type out today. The curious reader will find more details in the ‚ÄúFurther Reading‚Äù section.<p>The code for this article is available on <a href=https://github.com/steelswords/linux-kernel-modules rel=noopener target=_blank>my Github</a>.<p>Of course, I started this project by adapting my ‚ÄúHello, World‚Äù kernel module from the last article. Then I began working in the dynamic major number allocation and resource creation functions described in <em>Linux Device Drivers</em>. My code was building and running alright:</p><img alt="Parital success" class=dimmable-image height=260 src=https://tristanandrus.com/img/articles/linux-kernel-development/part2-not-in-dev.png width=954><p>But there was nothing in <code>/dev</code>! Our device did make it into <code>/sys</code>, but not all the way to <code>/dev</code>. I turned to some more recent sources to fix my problems. I‚Äôm not sure if <em>Linux Device Drivers</em> is just too old to reference here (I suspect not), or if I missed a crucial section in my late-night, new-parent reading of it. Either way, I found some help courtesy of Derek Molloy‚Äôs examples, linked below.<p>I was getting abysmal speed through SSH, so I soldered on the GPIO headers and busted out the serial console. Because embedded engineers can have nice things too, I‚Äôm using <code>tmux</code> over my serial connection. This not only lets me have multiple terminals open, but it also maintains them if my cable gets unplugged.<p>First thing to do is to copy our new module over and run it.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> /lib/modules/5.15.84+/kernel</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> cp /tmp/fibonacci.ko .</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> modprobe fibonacci</span>
</span></code></pre><p>Then we can see what <code>dmesg</code> has to say.</p><img alt="dmesg says the device was created successfully" class=dimmable-image height=114 src=https://tristanandrus.com/img/articles/linux-kernel-development/part2-dmesg.png width=727><p>That‚Äôs good news! Everything seems to have loaded properly. Let‚Äôs check that our device is in <code>/dev</code>.</p><img alt="Listing of /dev showing fibonacci0" class=dimmable-image height=114 src=https://tristanandrus.com/img/articles/linux-kernel-development/part2-ls-dev.png width=727><p>Nice! Now let‚Äôs read from it:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sudo</span></span><span class="z-meta z-function-call z-arguments z-shell"> cat /dev/fibonacci0</span>
</span></code></pre><p>At first, nothing was forthcoming. I was writing to the user-space buffer, but my return values were all off. Because it took me a while to figure out what was going on, I will include what I‚Äôve learned here.<h1 id=how-to-read><a aria-label="Anchor link for: how-to-read" class="header-anchor no-hover-padding" href=#how-to-read><span aria-hidden=true class=link-icon></span></a> How to <code>read()</code></h1><p>The prototype for our <code>read()</code> function looks like this:<pre class="language-C z-code" data-lang=C><code class=language-C data-lang=C><span class="z-source z-c"><span class="z-support z-type z-sys-types z-c">ssize_t</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">mydriver_read</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> file <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">filePointer</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">char</span><span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c">userspaceBuffer</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-support z-type z-sys-types z-c">size_t</span> <span class="z-variable z-parameter z-c">sizeOfUserspaceBuffer</span><span class="z-punctuation z-separator z-c">,</span> loff_t <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">offset</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span></span></code></pre><p>The first argument is a pointer to a <code>struct file</code>. This tells the driver which file is being accessed from userspace. It would be important if I were writing a driver that handled multiple files, but since I am only ever dealing with one file I don‚Äôt particularly care about this argument.<p>The second argument, <code>userspaceBuffer</code>, is a pointer to a buffer in userspace. This is the destination buffer. You want to copy your data, which is currently in kernel memory, into that userspace buffer. This, like most things in kernel development, is not something you can just <code>strcpy()</code> away. Thanks to the differences in kernel memory and regular, paged userspace memory, you could open up security holes or trigger a page fault from kernel code (which is a no-no), or other icky things. So how the heck do we get data into that buffer? Thankfully, the Linux kernel API provides a nifty function for us that works much like <code>strcpy</code>: <code>copy_to_user()</code>. It works much the same way, but it makes sure that all the virtual memory details are all squared away.<p>The program in userland making this read() call passes in the size of it‚Äôs receiving buffer, which I have here named <code>sizeOfUserspaceBuffer</code>, as well as an <code>offset</code>. We set that <code>offset</code> in our driver code. It represents how much of the kernel buffer we have already read. I‚Äôll explain a little more below.<h2 id=return-values><a aria-label="Anchor link for: return-values" class="header-anchor no-hover-padding" href=#return-values><span aria-hidden=true class=link-icon></span></a> Return Values</h2><p>Valid return values for our <code>read()</code> function are:<ul><li><ol start=0><li>This indicates that the end of the file has been reached. The userspace program assumes that no data has been transferred.</ol><li>Negative value. Indicates an error<li>Non-negative value. Indicates the number of bytes copied into the receiving userspace buffer. That is, how much was ‚Äúread‚Äù.</ul><p>So how does this work with <code>offset</code>? If I have 48 bytes in my driver for the user to read, they <code>read()</code> and give me a pointer to a 32-byte buffer, then I set <code>offset</code> to 32, since that is where we want the user to next call <code>read()</code>. (Userspace will keep calling <code>read()</code> until I return a value that indicates they have consumed all the available data.) Next time, I get a <code>read()</code> call with <code>offset</code> of 32, and I know to pass bytes 32-47. Finally, the third time I get a <code>read()</code> call, I return 0 to let the userspace program know it got all the data I had.<h1 id=putting-it-all-together><a aria-label="Anchor link for: putting-it-all-together" class="header-anchor no-hover-padding" href=#putting-it-all-together><span aria-hidden=true class=link-icon></span></a> Putting it all together</h1><p>So I made this adjustment to my code and‚Ä¶</p><img alt="Success! Reading fibonacci numbers out of a character device" class=dimmable-image height=317 src=https://tristanandrus.com/img/articles/linux-kernel-development/part2-success.png width=727><p>Huzzah! That‚Äôs just what we wanted. Whew! I don‚Äôt think I‚Äôve ever worked that hard to generate the Fibonacci series.<h1 id=further-reading><a aria-label="Anchor link for: further-reading" class="header-anchor no-hover-padding" href=#further-reading><span aria-hidden=true class=link-icon></span></a> Further Reading</h1><ul><li><a href=https://linux-kernel-labs.github.io/refs/heads/master/labs/device_drivers.html rel=noopener target=_blank>https://linux-kernel-labs.github.io/refs/heads/master/labs/device_drivers.html</a><li><a href=https://static.lwn.net/images/pdf/LDD3/ch03.pdf rel=noopener target=_blank>https://static.lwn.net/images/pdf/LDD3/ch03.pdf</a><li><a href=https://www.kernel.org/doc/htmldocs/kernel-api/index.html rel=noopener target=_blank>Linux Kernel API Reference</a><li><a href=http://derekmolloy.ie/writing-a-linux-kernel-module-part-2-a-character-device/ rel=noopener target=_blank>Derek Molloy‚Äôs treatment of the subject</a></ul></section></article></main><span class=hidden id=copy-success> Copied! </span><span class=hidden id=copy-init> Copy code to clipboard </span><script defer src=https://tristanandrus.com/js/copyCodeToClipboard.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://tristanandrus.com/atom.xml rel=noopener target=_blank> <img alt=feed loading=lazy src=https://tristanandrus.com/social_icons/rss.svg title=feed> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://github.com/steelswords/ target=_blank> <img alt=github loading=lazy src=https://tristanandrus.com/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://www.linkedin.com/in/tristan-andrus target=_blank> <img alt=linkedin loading=lazy src=https://tristanandrus.com/social_icons/linkedin.svg title=linkedin> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://fosstodon.org/@steelswords target=_blank> <img alt=mastodon loading=lazy src=https://tristanandrus.com/social_icons/mastodon.svg title=mastodon> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://bsky.app/profile/steelswords.bsky.social target=_blank> <img alt=bluesky loading=lazy src=https://tristanandrus.com/social_icons/bluesky.svg title=bluesky> </a></ul></nav><nav class=nav-navs></nav><div class=credits><small> Powered by <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> & <a href=https://github.com/welpo/tabi rel=noopener target=_blank>tabi</a> </small></div></section></footer>