<!doctype html><html data-theme=dark lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://tristanandrus.com name=base><title>Tristan Andrus â€¢ A Script to Report Unscheduled Hours Left in the Day</title><link href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 105 55"><text y=".7em" font-size="82">ðŸ’»</text></svg>' rel=icon><link title="Tristan Andrus - Atom Feed" href=https://tristanandrus.com/atom.xml rel=alternate type=application/atom+xml><link href="https://tristanandrus.com/spoilersection.css?h=a8f027ae57acf043de52" rel=stylesheet><link href="https://tristanandrus.com/attributedblockquote.css?h=1b96ca8639a3c4a94489" rel=stylesheet><link href="https://tristanandrus.com/custom_subset.css?h=0b9535a28bc3d5bf2321" rel=stylesheet><link href="https://tristanandrus.com/main.css?h=4a3dff148c520f191505" rel=stylesheet><meta content=dark name=color-scheme><meta content="Getting synced Calendar events from GNOME Calendar is harder than it looks." name=description><meta content="Getting synced Calendar events from GNOME Calendar is harder than it looks." property=og:description><meta content="index, nofollow" name=robots><meta content="A Script to Report Unscheduled Hours Left in the Day" property=og:title><meta content=article property=og:type><meta content=en_GB property=og:locale><meta content=https://tristanandrus.com/blog/getting-calendar-events-from-gnome-synced-accounts/ property=og:url><meta content="Tristan Andrus" property=og:site_name><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'" http-equiv=Content-Security-Policy><script defer src=https://tristanandrus.com/js/toggle_spoiler.js></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://tristanandrus.com>Tristan Andrus</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://tristanandrus.com/experience/> experience </a><li><a class="nav-links no-hover-padding" href=https://tristanandrus.com/blog/> blog </a><li><a class="nav-links no-hover-padding" href=https://tristanandrus.com/tags/> tags </a><li><a class="nav-links no-hover-padding" href=https://tristanandrus.com/archive/> archive </a></li><div class=nav-navs id=menu-icons-group></div></ul></div></nav></header><div class=content><main><article><h1 class=article-title>A Script to Report Unscheduled Hours Left in the Day</h1><ul class=meta><li>12th May 2024<li title="834 words"><span aria-hidden=true class=separator>â€¢</span>5 min read<li class=tag><span aria-hidden=true class=separator>â€¢</span>Tags:Â <li class=tag><a href=https://tristanandrus.com/tags/linux/>linux</a>,Â <li class=tag><a href=https://tristanandrus.com/tags/tweaks/>tweaks</a>,Â <li class=tag><a href=https://tristanandrus.com/tags/python/>python</a></ul><section class=body><h1 id=a-tale-as-old-as-time><a aria-label="Anchor link for: a-tale-as-old-as-time" class="header-anchor no-hover-padding" href=#a-tale-as-old-as-time><span aria-hidden=true class=link-icon></span></a> A Tale as Old as Time</h1><p>If I had a trivial amount of currency for every time an engineer said, "It shouldn't be too hard to XYZ. All you'd have to do is ABC," I would have an exceptionally non-trivial amount of currency. This is one of those stories.<p>I use Tmux extensively. If I could run my whole life from a terminal emulator, I would. But I haven't played very much with ricing the thing yet. "What would be useful to add to the status line?" I wondered. IPv4 address? Certainly. But much else that's offered out of the box.... I don't know.<p>That's when it hit me. What if I could put the number of usuable hours left in the work day in the status line? Like <code>5pm - now - (meetings from now till 5pm)</code>. Sounds great, right? I already have my work calendar synced up on my work computer, and my personal ones on my personal computer. How hard would it be to get those events from wherever GNOME stores them?<h1 id=querying-calendar-events><a aria-label="Anchor link for: querying-calendar-events" class="header-anchor no-hover-padding" href=#querying-calendar-events><span aria-hidden=true class=link-icon></span></a> Querying Calendar Events</h1><p>The answer, of course, is harder than I thought. I believe I have stumbled on one of those rare coding subjects that not a great many people dabble in. I will spare the reader a long winded account of my grueling research process and leave my "final recipe," so to speak, for any interested parties in the future.<p>I know that I sync my work calendar to my desktop through Evolution-EWS, because the built-in Pop!_OS stuff does not support Office 365. (Thanks, Microsoft.) So my first attempts were to look at how to connect to whatever Evolution uses on the back end. For this, you will need to access the <code>EDataServer</code>. For the longest time, I could only find <a href=https://discourse.gnome.org/t/accessing-evolution-calendars-from-scripts/17884 rel=noopener target=_blank>this forum post</a>, which leads you to the <a href=https://gnome.pages.gitlab.gnome.org/evolution-data-server/libedataserver/method.SourceRegistry.list_enabled.html rel=noopener target=_blank>Evolution Data Server documentation</a>. But the API was all documented in C.<p>I love C, but I had already determined that since I wanted this tool to be part of my scripts repo, easy to deploy onto new machines and run from Tmux, I wanted to use Python. I thought that would give me the most portability without having to maintain a binary anywhere.<p>It took me a while to find the Python docs for what I needed, but <a href=https://amolenaar.pages.gitlab.gnome.org/pygobject-docs/index.html rel=noopener target=_blank>eventually I found the Python docs for PyGObject</a>. Looking for EDataServer, you learn that you need to create an <code>EDataServer.SourceRegistry</code> object, <code>list_sources</code> on it, and then connect an <code>ECal.Client</code> to each one of the sources.<p>Then if you don't want to get <em>every event ever entered on each calendar</em>, you have to specify a search query using an S-expression.<p>What is an S-expression, you might ask? Great question! It's a LISP-like object made from parentheses and fever dreams of documented APIs. There is literally no documentation on the format (see "It's all in the code (TM)"", below).<p>But here are the bits and pieces I was able to scrape together to let me write a proper S-expression for these queries.<ul><li><a href=https://discourse.gnome.org/t/how-do-i-use-s-expressions-on-evolution-data-servers-ecal-api/9044 rel=noopener target=_blank>It's all in the code (TM)</a><li><a href=https://github.com/elementary/calendar/blob/1099ba61def44231cbbb9ab594432bda32643720/core/Services/Calendar/EventStore.vala#L410 rel=noopener target=_blank>One paltry example</a><li><a href=https://mail.gnome.org/archives/evolution-hackers/2022-March/msg00001.html rel=noopener target=_blank>Actually good examples</a></ul><p>Think you're set to write some good queries in S-expressions? There's one more gotcha you should know about.<p>The ranges are <strong>exclusive, not inclusive</strong>. So if you have an event that goes from 4-5pm, and you query all events from 9 am to 5 pm, you won't get that 4pm event.<p>In my script I just add a second to the end and subtract a second from the beginning time, so I'm querying from 8:59:59 to 5:00:01 during work hours.<h1 id=other-neat-features><a aria-label="Anchor link for: other-neat-features" class="header-anchor no-hover-padding" href=#other-neat-features><span aria-hidden=true class=link-icon></span></a> Other neat features</h1><p>I try to keep the deltas between the configs and setup on my work and personal to a minimum. So I put some business logic in to intelligently determine which part of the day we are calling the script in and thus, how many hours are left until the next phase of the day. These are the parts that are supported:<ul><li>Early morning before work<li>At work<li>After work, but before bedtime<li>After bedtime, but before a reasonable wake up hour.</ul><p>The last two I hope will be useful for personal regulation. Sometimes I get so caught up in a project it can be hard to extract myself to rest for the night.<p>And there you have it! A script that reads from your synced calendars and tells you how many free hours you have until your next stage if the day!<h1 id=the-code><a aria-label="Anchor link for: the-code" class="header-anchor no-hover-padding" href=#the-code><span aria-hidden=true class=link-icon></span></a> The Code</h1><p>You can find the full script in <a href=https://github.com/steelswords/scripts/blob/master/time-left-in-day.py rel=noopener target=_blank>my scripts repo on GitHub</a>.</section></article></main><span class=hidden id=copy-success> Copied! </span><span class=hidden id=copy-init> Copy code to clipboard </span><script defer src=https://tristanandrus.com/js/copyCodeToClipboard.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://tristanandrus.com/atom.xml rel=noopener target=_blank> <img alt=feed loading=lazy src=https://tristanandrus.com/social_icons/rss.svg title=feed> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://github.com/steelswords/ target=_blank> <img alt=github loading=lazy src=https://tristanandrus.com/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://www.linkedin.com/in/tristan-andrus target=_blank> <img alt=linkedin loading=lazy src=https://tristanandrus.com/social_icons/linkedin.svg title=linkedin> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://fosstodon.org/@steelswords target=_blank> <img alt=mastodon loading=lazy src=https://tristanandrus.com/social_icons/mastodon.svg title=mastodon> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://bsky.app/profile/steelswords.bsky.social target=_blank> <img alt=bluesky loading=lazy src=https://tristanandrus.com/social_icons/bluesky.svg title=bluesky> </a></ul></nav><nav class=nav-navs></nav><div class=credits><small> Powered by <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> & <a href=https://github.com/welpo/tabi rel=noopener target=_blank>tabi</a> </small></div></section></footer>